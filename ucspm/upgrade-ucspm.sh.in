#!/bin/sh
#
###############################################################################
#
# Upgrade UCSPM
#
###############################################################################
set -e
export UCSPM_TENANT_ID="`serviced service list ucspm --format='{{.ID}}'`"
serviced snapshot untag $UCSPM_TENANT_ID preupgrade-ucspm-%VERSION%

FROM_VERSION=$(serviced service list ucspm --format='{{.Version}}')
FROM_VERSION_SHORT=$(cut -d'.' -f1,2 <<< $FROM_VERSION)
sed -i 's/REPLACE/'"$FROM_VERSION_SHORT:$FROM_VERSION"'/g' /root/%SHORT_VERSION%.x/current_version.txt
serviced script run /root/%SHORT_VERSION%.x/current_version.txt --service ucspm

serviced script run /root/%SHORT_VERSION%.x/upgrade-ucspm.txt --service ucspm
/opt/serviced/bin/serviced-set-version UCSPM %UCSPM_VERSION%
