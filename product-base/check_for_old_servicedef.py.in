#!/usr/bin/env python


import json
import subprocess


class ServicedefParseError(Exception):
    pass


def serviced(*args, **kwargs):
    cmd = ["serviced"]
    cmd.extend(args)
    proc = subprocess.Popen(cmd,
                            stdin=subprocess.PIPE,
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE)
    stdout, stderr = proc.communicate(kwargs.get("stdin"))
    return '\n'.join((stdout, stderr)).strip()

def check_servicedef_too_old(rootservice, minversion):
    root = json.loads(serviced('service', 'list', '-v', rootservice))

    return root["Version"] < minversion

if __name__ == '__main__':
    from argparse import ArgumentParser
    import sys
    ap = ArgumentParser()
    ap.add_argument("rootservice", type=str)
    ap.add_argument("minversion", type=str)
    args = ap.parse_args()
    try:
        if check_servicedef_too_old(args.rootservice, args.minversion):
            sys.exit(1)
    except ServicedefParseError:
        sys.exit(1)
